<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Rocking the world</title>
  <meta name="author" content="stephan">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Rocking the world"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.pn" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Rocking the world</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1>Rocking the world</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Yet another bootstrap theme.
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-12-28 </div>
			<div class="article-title"><a href="/2015/12/28/setup-nodejs-on-windows-as-a-build-server/" >setup nodejs on windows as a build server</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>Installing NodeJS<br>Jenkins NodeJS plugin does not work on Windows, so we’ll do a manual installation.</p>
<p>Download latest stable version (e.g. 0.10.35) from <a href="http://nodejs.org/" target="_blank" rel="external">http://nodejs.org/</a></p>
<p>Don’t install to default directory C:\Program Files\nodejs as it requires administration rights, prefer a simpler path like c:\nodejs.</p>
<p><a href="http://blog.majgis.com/npm-nodejs-fails-when-run-from-jenkins-on-windows/" target="_blank" rel="external">http://blog.majgis.com/npm-nodejs-fails-when-run-from-jenkins-on-windows/</a></p>
<p>Edit C:\nodejs\node_modules\npm\npmrc to replace<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prefix=<span class="variable">$&#123;APPDATA&#125;</span>\npm</span><br></pre></td></tr></table></figure></p>
<p>by</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prefix=C:\nodejs\node_modules\npm</span><br></pre></td></tr></table></figure>
<p>Add the ‘C:\nodejs\node_modules\npm’ folder to the PATH environment variable, remove the one that was added by the installer: ‘C:\Users<user>\AppData\Roaming\npm’</user></p>
<p>npm may require git, install it from <a href="http://msysgit.github.io/" target="_blank" rel="external">http://msysgit.github.io/</a></p>
<p>Add bower and grunt:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g bower grunt-cli</span><br><span class="line">bower --version</span><br><span class="line">grunt --version</span><br></pre></td></tr></table></figure></p>

	
	</div>
  <a type="button" href="/2015/12/28/setup-nodejs-on-windows-as-a-build-server/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-12-27 </div>
			<div class="article-title"><a href="/2015/12/27/notes-of-powershell/" >notes of powershell</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="using_where_in_pipeline">using where in pipeline</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Clear-Host</span><br><span class="line"><span class="variable">$objNetwork</span> = <span class="built_in">Get-WmiObject</span> -List | Where &#123;<span class="variable">$_</span>.name <span class="operator">-Match</span> <span class="string">"Network"</span>&#125;</span><br><span class="line"><span class="variable">$objNetwork</span> | <span class="built_in">Format-Table</span> name</span><br></pre></td></tr></table></figure>
	
	</div>
  <a type="button" href="/2015/12/27/notes-of-powershell/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-23 </div>
			<div class="article-title"><a href="/2015/11/23/new-way-to-to-manage-software-on-windows/" >new way to to manage software on windows</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>In the previous post we mentioned about <code>Chocolatey</code>, this time let’s do some more interest things which related to it.</p>
<p>After <code>Chocolatey</code> installed.</p>
<p><code>scriptcs</code> makes it easy to write and execute C# with a simple text editor.</p>
<p>To install <code>scriptcs</code>, just run scriptcs</p>

	
	</div>
  <a type="button" href="/2015/11/23/new-way-to-to-manage-software-on-windows/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-23 </div>
			<div class="article-title"><a href="/2015/11/23/10-tools-that-change-your-life/" >10 tools that change your life</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<blockquote><p>“Productivity is being able to do things that you were never able to do before.”</p>
<footer><strong>Franz Kafka</strong></footer></blockquote>
<p>引自 <a href="http://zhuanlan.zhihu.com/always-a-tool/19662365" target="_blank" rel="external">知乎</a> <a href="http://www.hanselman.com/blog/ScottHanselmans2014UltimateDeveloperAndPowerUsersToolListForWindows.aspx" target="_blank" rel="external">UltimateDeveloperAndPowerUsersToolListForWindows</a></p>
<ul>
<li><a href="http://www.chocolatey.org/" target="_blank" rel="external">Chocolatey</a> - 名字很奇特，但它可是 Windows 上的 apt-get。一旦拥有，别无所求。现在我想装软件的时候，会首先想到它而不是 Google。刚刚我还在用 ‘cinst filezilla’ 和 ‘cinst winscp’ 来安装我想要的东西呢。想想看，利用它你就可以把「装机」变成一个极其简单的事情。不过自己写脚本还是太复杂，对于装机，你应该用……<ul>
<li><a href="http://boxstarter.org/" target="_blank" rel="external">Boxstarter</a> - Matt Wrock 利用 Chocolatey 和 Nuget 构建了这个神奇的东西。它可以大幅简化你在更新电脑时候的工作，也可以在远程机器或者虚拟机上进行无人值守的环境部署。</li>
</ul>
</li>
<li><a href="http://codesector.com/teracopy" target="_blank" rel="external">TeraCopy</a> - 大多数时候我都用 Windows 8.1 自带的复制，不过如果我真要搬运一大堆东西的话我会用 TeraCopy。正如其名它做的事情就是复制，而且在速度上，无出其右。</li>
<li><a href="http://nimbletext.com/" target="_blank" rel="external">NimbleText</a> - 正则表达式很难写，我也学不会。NumbleText 则可以让你轻松地处理大量文字。</li>
<li><a href="https://github.com/bmatzelle/gow" target="_blank" rel="external">GOW Gnu on Windows</a> - 当你只需要 *nix 工具的时候装 Cygwin 未免小题大做。 Gow 就是 130 个编译成原生 Windows EXE 的 Unix 命令行工具，仅此而已。</li>
<li><a href="http://justgetflux.com/" target="_blank" rel="external">F.lux</a> - 说实话，一开始我觉得这玩意挺蠢的，但是再用完几天之后我就收回了那些想法。F.lux 会随着每天时间的变化来调整显示器色温，在晚上就能让显示器色调更暖。对于一个整天对着三个巨屏的人来说这是福利。自从用来 F.lux 我再也不头痛了，眼酸的症状也缓解了很多。试试看，你会喜欢上的。</li>
<li><a href="http://www.autohotkey.com/" target="_blank" rel="external">AutoHotKey</a> - 这个开源小东西碉堡了。你可以吧复杂的工作变成简单的快捷键，非程序员的变成利器。它可以用极其简单的方法来自动化 Windows 操作，堪称 Windows 平台的 Applescript。<ul>
<li>别忘了<a href="http://www.autohotkey.com/forum/topic21703.html" target="_blank" rel="external">Window Pad</a> - 超赞的好东西，完全是用 AHK 写成的！</li>
</ul>
</li>
<li><a href="http://www.getpaint.net/index.html" target="_blank" rel="external">Paint.NET</a> - Windows 应该 内置 的画图程序，基于 .NET 平台，用免费的价格换取 Photoshop 80% 的能力。目前 Paint.NET 正在积极开发它的第四版！</li>
<li><a href="http://download.live.com/writer" target="_blank" rel="external">Windows Live Writer</a> - 如果你有博客，那它是胃液素神器。它还有一个不错的 插件库。它应该停止更新了，但生命力依旧旺盛。</li>
</ul>

	
	</div>
  <a type="button" href="/2015/11/23/10-tools-that-change-your-life/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-19 </div>
			<div class="article-title"><a href="/2015/11/19/void-to-input-username-and-password-when-using-git/" >void to input username and password when using git</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>using git bash.<br>vim ~/.get-credentials<br><code>https://myusername:mypassword@git.oschina.net</code></p>
<p><code>git config credential.https://git.oschina.net.username myusername [--global]</code><br><code>git config credential.helper store --file=~/.git-credentials [--global]</code></p>
<p><code>git config credential.helper store</code></p>

	
	</div>
  <a type="button" href="/2015/11/19/void-to-input-username-and-password-when-using-git/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-19 </div>
			<div class="article-title"><a href="/2015/11/19/how-to-fix-file-is-open-in-another-program-on-windows/" >how to fix file is open in another program on windows</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>Why can’t I delete or move a file or folder?<br>What program is stopping me from deleting or moving a file or folder?<br>You really what to find the “Stupid guy” who is ocuppying the file?</p>
<p>Here you go! Boo.. There is an application called <code>Microsoft Process Explorer</code>.<br>Run it.<br>Go the menu bar of <code>Microsoft Process Explorer</code>.<br><code>Find</code> =&gt; <code>Here input the folder/file which you cannot delete.</code></p>
<p>It will show you which process ocupy it.</p>

	
	</div>
  <a type="button" href="/2015/11/19/how-to-fix-file-is-open-in-another-program-on-windows/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-18 </div>
			<div class="article-title"><a href="/2015/11/18/how-to-know-the-install-status-for-a-msi-installer/" >how to know the install status for a msi installer</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>Refer to <a href="http://stackoverflow.com/questions/320921/how-to-add-a-wix-custom-action-that-happens-only-on-uninstall-via-msi" target="_blank" rel="external">http://stackoverflow.com/questions/320921/how-to-add-a-wix-custom-action-that-happens-only-on-uninstall-via-msi</a></p>

	
	</div>
  <a type="button" href="/2015/11/18/how-to-know-the-install-status-for-a-msi-installer/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-12 </div>
			<div class="article-title"><a href="/2015/11/12/create-a-wcf-client-wrapper/" >Create a smart wcf client wrapper</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="A_good_start_for_wcf_client_programing-">A good start for wcf client programing.</h2><p>In the last article we presented a solution for calling WCF services that needed only a single line of code and no using statements.  But it had many limitations including</p>
<ul>
<li>Reliance on a static class</li>
<li>Testability was low for any code using it</li>
<li>Reliance on the WCF client rather than the contract</li>
<li>Not optimized for multiple calls<br>In reality the previous series of articles where all about setting up the infrastructure to support the final solution.  All this infrastructure will be hidden from code when we are done.  Let’s get started.</li>
</ul>
<h2 id="Service_Template">Service Template</h2><p>Ultimately we will be using T4 to generate service clients but the templates are complex and we do not yet even have an idea of what we’re building.  For this article we will build the final service client by hand.  In subsequent articles we will convert the code to a template. </p>
<p>The service client should meet the following goals</p>
<ul>
<li>Creatable using a standard new operator with no requirements for specifying any WCF endpoint information.</li>
<li>Implement the WCF contract interface so instances can be used as parameters such as in an IoC.</li>
<li>Instances do not need to be disposed.</li>
<li>Should allow multiple calls to be optimized through the same client.</li>
<li>Extensible to allow callers to adjust the client if needed.</li>
</ul>
<h2 id="ServiceChannelClient">ServiceChannelClient</h2><p>To start we will create a new abstract class that will serve as the base class for service clients.  While we could reuse the ServiceClientWrapper of previous articles that would expose too much WCF infrastructure.  Instead the class will wrap calls to <code>ServiceClientWrapper</code> and <code>ServiceClientFactory</code> from the previous articles.  All the functionality is protected since this is an abstract class.</p>
<figure class="highlight c"><figcaption><span>#</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> abstract <span class="keyword">class</span> ServiceChannelClient&lt;TChannel&gt; where TChannel: <span class="keyword">class</span> </span><br><span class="line">&#123; </span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">virtual</span> ServiceClientWrapper&lt;TChannel&gt; CreateInstance () </span><br><span class="line">   &#123; <span class="keyword">return</span> ServiceClientFactory.CreateAndWrap&lt;TChannel&gt;(); &#125; </span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">InvokeMethod</span> <span class="params">( Action&lt;TChannel&gt; action )</span> </span><br><span class="line">   </span>&#123; ServiceClientFactory.InvokeMethod&lt;TChannel&gt;(action, CreateInstance); &#125; </span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">virtual</span> TResult InvokeMethod&lt;TResult&gt; ( Func&lt;TChannel, TResult&gt; action ) </span><br><span class="line">   &#123; <span class="keyword">return</span> ServiceClientFactory.InvokeMethod&lt;TChannel, TResult&gt;(action, CreateInstance); &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Basically the class just wraps the classes from previous articles.  It is about to get more functionality but first let’s implement a WCF service client using the class.</p>
<h2 id="Typed_Service_Clients">Typed Service Clients</h2><p>Creating a class to wrap a WCF service is now pretty straightforward (depending upon the size of the interface).  We need only create a derived type and implement the interface using the methods provided in the base class.<br><figure class="highlight c"><figcaption><span>#</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> EmployeeServiceClient : ServiceChannelClient&lt;IEmployeeService&gt; , IEmployeeService </span><br><span class="line">&#123; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> Employee <span class="title">Get</span> <span class="params">( <span class="keyword">int</span> id )</span> </span><br><span class="line">   </span>&#123; <span class="keyword">return</span> InvokeMethod&lt;Employee&gt;(c =&gt; c.Get(id)); &#125; </span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Employee <span class="title">Update</span> <span class="params">( Employee employee )</span> </span><br><span class="line">   </span>&#123; <span class="keyword">return</span> InvokeMethod&lt;Employee&gt;(c =&gt; c.Update(employee)); &#125;  </span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> IEnumerable&lt;Employee&gt; GetEmployees () </span><br><span class="line">   &#123; <span class="keyword">return</span> InvokeMethod&lt;IEnumerable&lt;Employee&gt;&gt;(c =&gt; c.GetEmployees()); &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>If we wanted we could make all the methods virtual to allow for extensibility.  We could also mark the type as partial to extend its abilities but the above code is sufficient until we move to T4. </p>
<p>Switching the application over to use the new client is straightforward.</p>
<ul>
<li>Remove the service reference code</li>
<li>Add the service interface assembly to the project</li>
<li>Replace all the existing calls with the new type<br>When the service reference code is removed it will remove the configuration entry for the service as well so that information will need to be put back in.  For now ensure the endpoint name matches the class name and that the contract name matches the namespace name of the interface.</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">!—-</span> <span class="attribute">Original</span> <span class="attribute">-</span>–&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="title">client</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="title">endpoint</span> <span class="attribute">address</span>=<span class="value">"http://localhost:21054/EmployeeService.svc"</span> </span><br><span class="line">                 <span class="attribute">binding</span>=<span class="value">"basicHttpBinding"</span></span><br><span class="line">                 <span class="attribute">bindingConfiguration</span>=<span class="value">"BasicHttpBinding_IEmployeeService"</span> </span><br><span class="line">                 <span class="attribute">contract</span>=<span class="value">"ServiceReference1.IEmployeeService"</span> </span><br><span class="line">                 <span class="attribute">name</span>=<span class="value">"BasicHttpBinding_IEmployeeService"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">client</span>&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">!—-</span> <span class="attribute">New</span> <span class="attribute">-</span>–&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="title">client</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="title">endpoint</span> <span class="attribute">address</span>=<span class="value">"http://localhost:21054/EmployeeService.svc"</span> </span><br><span class="line">                 <span class="attribute">binding</span>=<span class="value">"basicHttpBinding"</span> </span><br><span class="line">                 <span class="attribute">bindingConfiguration</span>=<span class="value">"BasicHttpBinding_IEmployeeService"</span> </span><br><span class="line">                 <span class="attribute">contract</span>=<span class="value">"ServiceLib.IEmployeeService"</span></span><br><span class="line">                 <span class="attribute">name</span>=<span class="value">"EmployeeServiceClient"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="title">client</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The matching of the endpoint name with the client type name is only a convenience.  We can add a constructor that allows the endpoint name to be specified if we want.  Finally we can fix up the calls to the client.</p>
<figure class="highlight c"><figcaption><span>#</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Original </span></span><br><span class="line">ServiceClientFactory.InvokeMethod&lt;ServiceReference1.IEmployeeService&gt;(c =&gt; </span><br><span class="line">&#123; </span><br><span class="line">   dataGridView1.DataSource = c.GetEmployees(); </span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line"><span class="comment">//New </span></span><br><span class="line">dataGridView1.DataSource = Client.GetEmployees(); </span><br><span class="line"></span><br><span class="line"><span class="comment">//Poor man's injection </span></span><br><span class="line"><span class="keyword">private</span> IEmployeeService Client </span><br><span class="line">&#123; </span><br><span class="line">    get &#123; <span class="keyword">return</span> m_client.Value; &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> readonly Lazy&lt;IEmployeeService&gt; m_client = <span class="keyword">new</span> Lazy&lt;IEmployeeService&gt;(() =&gt; <span class="keyword">new</span> EmployeeServiceClient());</span><br></pre></td></tr></table></figure>
<p>Now that we don’t need to dispose of objects or rely on static classes we can use just the interface which makes testing much easier.</p>
<h2 id="Multiple_Calls">Multiple Calls</h2><p>We’re almost done but we want to make one more change.  WCF service calls are not cheap so most calls tend to do several things at once rather than focusing on a single task like standard OOP would have you do.  But there are times when multiple calls are needed and the above code would require 2 client connections to be created.  Take, for example, this code in the sample application that creates 2 connections just to update an employee.</p>
<figure class="highlight c"><figcaption><span>#</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnNewEmployee</span> <span class="params">( object sender, EventArgs e )</span> </span><br><span class="line"></span>&#123; </span><br><span class="line">   var dlg = <span class="keyword">new</span> EmployeeForm();  </span><br><span class="line">   <span class="keyword">if</span> (dlg.ShowDialog(<span class="keyword">this</span>) != DialogResult.OK) </span><br><span class="line">      <span class="keyword">return</span>; </span><br><span class="line"></span><br><span class="line">   <span class="comment">//Call the service </span></span><br><span class="line">   Client.Update(dlg.Employee); </span><br><span class="line">   LoadEmployees(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadEmployees</span> <span class="params">( )</span> </span><br><span class="line"></span>&#123; </span><br><span class="line">   dataGridView1.DataSource = Client.GetEmployees(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What we want to do is allow the client to tell us they plan to make multiple calls so we can optimize the client creation.  Since the client needs to be able to define the lifetime of the calls it makes sense to use a using statement.  All we need to do is provide a mechanism for creating a type that controls the lifetime of our client.  We can add this directly to the base client.</p>
<figure class="highlight c"><figcaption><span>#</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> abstract <span class="keyword">class</span> ServiceChannelClient&lt;TChannel&gt; : </span><br><span class="line">     ISupportsPersistentChannel where TChannel: <span class="keyword">class</span> </span><br><span class="line">&#123; </span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">bool</span> HasOpenChannel </span><br><span class="line">   &#123; </span><br><span class="line">      get &#123; <span class="keyword">return</span> m_channel != null; &#125; </span><br><span class="line">   &#125;  </span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CloseChannel</span> <span class="params">()</span> </span><br><span class="line">   </span>&#123; </span><br><span class="line">      var channel = Interlocked.Exchange(ref m_channel, null); </span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (channel != null)  </span><br><span class="line">          channel.Close(); </span><br><span class="line">   &#125; </span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">virtual</span> ServiceClientWrapper&lt;TChannel&gt; CreateInstance () </span><br><span class="line">   &#123; <span class="keyword">return</span> ServiceClientFactory.CreateAndWrap&lt;TChannel&gt;(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now the base class can have a temporary or permanent connection open depending upon the caller’s needs.  But how do we expose this to the caller?  Introducing the <code>ISupportsPersistentChannel</code> interface.  The sole purpose of this interface is to expose Open/Close methods.  Notice the methods are not exposed publicly but only through the interface.  This prevents callers from calling these methods accidentally.  Why is this important?  Why do we need an interface?  It’s all about interchangeability.</p>
<h2 id="Creating_A_Persistent_Channel">Creating A Persistent Channel</h2><p>Remember that one of the requirements is that we want to be able to use the service interface directly without regards to the implementation, including mocks.  Therefore persistence cannot require that we use the client class.  Instead we add an extension to the interface which gives us the ability to open a persisted channel irrelevant of the implementation.  The caller code will work the same whether we’re using our client type or a test mock.  Here’s the implementation.</p>
<figure class="highlight c"><figcaption><span>#</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> EmployeeServiceExtensions </span><br><span class="line">&#123; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IDisposable <span class="title">OpenPersistentChannel</span> <span class="params">( <span class="keyword">this</span> IEmployeeService source )</span> </span><br><span class="line">   </span>&#123; </span><br><span class="line">      var batch = source as ISupportsPersistentChannel; </span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (batch != null) </span><br><span class="line">      &#123; </span><br><span class="line">         batch.Open();  </span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> ActionDisposable(batch.Close); </span><br><span class="line">      &#125;; </span><br><span class="line">       </span><br><span class="line">      <span class="keyword">return</span> Disposable.Empty; </span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The key is that the extension method will look for the <code>ISupportsPersistentChannel</code> interface.  For types deriving from <code>ServiceChannelClient</code> the interface will exist.  For other types it likely will not.  If the interface does exist then the channel is opened and an instance of a disposable class is returned that will close the channel.  Note the client itself is never returned.  If the interface does not exist then a disposable object is returned that does nothing.  This makes it safe for both production and test code.  Here’s how the caller would use it.</p>
<figure class="highlight c"><figcaption><span>#</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnNewEmployee</span> <span class="params">( object sender, EventArgs e )</span> </span><br><span class="line"></span>&#123; </span><br><span class="line">   var dlg = <span class="keyword">new</span> EmployeeForm(); </span><br><span class="line">   <span class="keyword">if</span> (dlg.ShowDialog(<span class="keyword">this</span>) != DialogResult.OK) </span><br><span class="line">      <span class="keyword">return</span>; </span><br><span class="line"></span><br><span class="line">   <span class="comment">//Call the service </span></span><br><span class="line">   <span class="keyword">using</span> (var proxy = Client.OpenPersistentChannel())   </span><br><span class="line">   &#123; </span><br><span class="line">      Client.Update(dlg.Employee); </span><br><span class="line">      LoadEmployees(Client);  </span><br><span class="line">   &#125;; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadEmployees</span> <span class="params">( )</span> </span><br><span class="line"></span>&#123; </span><br><span class="line">   LoadEmployees(Client); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadEmployees</span> <span class="params">( IEmployeeService service )</span> </span><br><span class="line"></span>&#123; </span><br><span class="line">   dataGridView1.DataSource = service.GetEmployees(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Next_Steps">Next Steps</h2><p>We are finally at the point where we have replaced the original service reference logic with a fully testable client that eliminates the dependency on WCF plumbing.  The resultant code is clean and can be mocked.  In the general case of single calls to WCF then the caller does not need to anything special.  For multiple calls the client (can) optimize performance with a <code>using</code> statement and it won’t break any test implementations.  The only issue remaining is the amount of code we’d need to generate for each WCF service.  The example client we created can be converted to a T4 template but it is going to require quite a bit of work.  However once we’re done we won’t have to revisit this code ever again.  We’ll pick up T4 next time.</p>
<p>Original from :<br><a href="http://blogs.msmvps.com/p3net/2014/03/15/a-smarter-wcf-service-client-part-4/" target="_blank" rel="external">http://blogs.msmvps.com/p3net/2014/03/15/a-smarter-wcf-service-client-part-4/</a><br><a href="http://blogs.msmvps.com/p3net/2014/05/18/a-smarter-wcf-service-client-part-5/" target="_blank" rel="external">http://blogs.msmvps.com/p3net/2014/05/18/a-smarter-wcf-service-client-part-5/</a></p>

	
	</div>
  <a type="button" href="/2015/11/12/create-a-wcf-client-wrapper/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-11 </div>
			<div class="article-title"><a href="/2015/11/11/wmi-query/" >WMI Query</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>The following WMI queries can be used as inspiration when working with driveres and other OS Deployment stuff…<br>IMPORTANT: If you copy/paste these queries, you might need to replace the quotes, as they often change format when you copy them from a website</p>

	
	</div>
  <a type="button" href="/2015/11/11/wmi-query/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-05 </div>
			<div class="article-title"><a href="/2015/11/05/upgrade-npm-on-windows/" >upgrade npm on windows</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>Powershell Run as Administrator<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Unrestricted -Scope CurrentUser -Force</span><br></pre></td></tr></table></figure></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g npm-windows-upgrade</span><br><span class="line">npm-windows-upgrade</span><br></pre></td></tr></table></figure>
<p>or Want to upgrade to specific version?</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm-windows-upgrade --version:<span class="number">3.1</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><a href="https://www.npmjs.com/package/npm-windows-upgrade" target="_blank" rel="external">Reference from npmjs.</a></p>

	
	</div>
  <a type="button" href="/2015/11/05/upgrade-npm-on-windows/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/Coding/">Coding<span>2</span></a></li>
		
			<li><a href="/categories/Programing/">Programing<span>1</span></a></li>
		
			<li><a href="/categories/coding/">coding<span>8</span></a></li>
		
			<li><a href="/categories/life/">life<span>2</span></a></li>
		
			<li><a href="/categories/reading/">reading<span>1</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/msi/">msi<span>1</span></a></li>
		
			<li><a href="/tags/nodejs/">nodejs<span>1</span></a></li>
		
			<li><a href="/tags/NET/">.NET<span>2</span></a></li>
		
			<li><a href="/tags/WCF/">WCF<span>1</span></a></li>
		
			<li><a href="/tags/words/">words<span>1</span></a></li>
		
			<li><a href="/tags/WMI/">WMI<span>1</span></a></li>
		
			<li><a href="/tags/BestPractice/">BestPractice<span>1</span></a></li>
		
			<li><a href="/tags/windows/">windows<span>5</span></a></li>
		
			<li><a href="/tags/tools/">tools<span>4</span></a></li>
		
			<li><a href="/tags/Ohters/">Ohters<span>1</span></a></li>
		
			<li><a href="/tags/node/">node<span>1</span></a></li>
		
			<li><a href="/tags/stuff/">stuff<span>1</span></a></li>
		
			<li><a href="/tags/Windows/">Windows<span>2</span></a></li>
		
			<li><a href="/tags/tips/">tips<span>10</span></a></li>
		
			<li><a href="/tags/npm/">npm<span>1</span></a></li>
		
			<li><a href="/tags/powershell/">powershell<span>1</span></a></li>
		
			<li><a href="/tags/git/">git<span>2</span></a></li>
		
			<li><a href="/tags/dailywork/">dailywork<span>3</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2015/12/28/setup-nodejs-on-windows-as-a-build-server/" ><i class="fa fa-file-o"></i>setup nodejs on windows as ...</a>
      </li>
    
      <li>
        <a href="/2015/12/27/notes-of-powershell/" ><i class="fa fa-file-o"></i>notes of powershell...</a>
      </li>
    
      <li>
        <a href="/2015/11/23/new-way-to-to-manage-software-on-windows/" ><i class="fa fa-file-o"></i>new way to to manage softwa...</a>
      </li>
    
      <li>
        <a href="/2015/11/23/10-tools-that-change-your-life/" ><i class="fa fa-file-o"></i>10 tools that change your l...</a>
      </li>
    
      <li>
        <a href="/2015/11/19/void-to-input-username-and-password-when-using-git/" ><i class="fa fa-file-o"></i>void to input username and ...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/catwarrior/catwarrior.github.io" title="Catwarrior's Github repository." target="_blank"]);">Catwarrior</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/catwarrior" title="My Github account." target="_blank"]);">My Github</a></li>
	
		<li><i class="fa fa-linkedin"></i><a href="http://www.linkedin.com/in/stephan" title="My Linkin account." target="_blank"]);">My LinkedIn</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2015 stephan
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
